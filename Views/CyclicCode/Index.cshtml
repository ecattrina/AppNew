@model AppNew.Models.CyclicCodeInputModel
@{
    ViewData["Title"] = "Кодирование в циклическом коде";
}

<div class="container mt-4">
    <h2 class="mb-4">Кодирование в циклическом коде</h2>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Описание</h5>
        </div>
        <div class="card-body">
            <p>Циклический код (n, k) с порождающим многочленом степени r = n - k.</p>
            <p><strong>Алгоритм кодирования:</strong></p>
            <ol>
                <li>Записать информационный полином m(x) (степени k-1)</li>
                <li>Умножить m(x) на x^r</li>
                <li>Разделить полученный полином на g(x) и найти остаток r(x)</li>
                <li>Кодовая комбинация: c(x) = x^r * m(x) + r(x)</li>
            </ol>
        </div>
    </div>

    <form asp-action="Encode" method="post" id="cyclicCodeForm">
        @Html.AntiForgeryToken()

        <div class="card mb-4">
            <div class="card-header">
                <h5>Входные данные</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label asp-for="CodeLength" class="form-label">Общая длина кода (n)</label>
                        <input asp-for="CodeLength" class="form-control" type="number" min="3" max="100" />
                        <span asp-validation-for="CodeLength" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="DataBits" class="form-label">Информационные биты (k)</label>
                        <input asp-for="DataBits" class="form-control" type="number" min="1" max="50" />
                        <span asp-validation-for="DataBits" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="GeneratorPolynomial" class="form-label">Порождающий многочлен g(x)</label>
                        <input asp-for="GeneratorPolynomial" class="form-control" type="text" placeholder="x^3+x+1" />
                        <span asp-validation-for="GeneratorPolynomial" class="text-danger"></span>
                        <small class="form-text text-muted">Например: x^3+x+1</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Информационные комбинации</label>
                    <div id="combinationsContainer">
                        @for (int i = 0; i < Model.InformationCombinations.Count; i++)
                        {
                            <div class="row mb-2 combination-row">
                                <div class="col-md-10">
                                    <input name="InformationCombinations[@i]" class="form-control combination-input" 
                                           type="text" value="@Model.InformationCombinations[i]" 
                                           placeholder="1111" />
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm remove-combination" 
                                            @(Model.InformationCombinations.Count <= 1 ? "disabled" : "")>Удалить</button>
                                </div>
                            </div>
                        }
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="addCombination">Добавить комбинацию</button>
                </div>
            </div>
        </div>

        <div asp-validation-summary="All" class="text-danger mb-3"></div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary">Закодировать</button>
            <button type="button" class="btn btn-secondary" id="resetForm">Сбросить</button>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('combinationsContainer');
            const dataBitsInput = document.querySelector('input[name="DataBits"]');
            let combinationIndex = @Model.InformationCombinations.Count;

            document.getElementById('addCombination').addEventListener('click', function() {
                const row = document.createElement('div');
                row.className = 'row mb-2 combination-row';
                row.innerHTML = `
                    <div class="col-md-10">
                        <input name="InformationCombinations[${combinationIndex}]" class="form-control combination-input" 
                               type="text" placeholder="1111" />
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm remove-combination">Удалить</button>
                    </div>
                `;
                container.appendChild(row);
                combinationIndex++;
                updateRemoveButtons();
            });

            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-combination')) {
                    const rows = container.querySelectorAll('.combination-row');
                    if (rows.length > 1) {
                        e.target.closest('.combination-row').remove();
                        updateRemoveButtons();
                        reindexCombinations();
                    }
                }
            });

            // Ограничиваем ввод только 0 и 1
            container.addEventListener('input', function(e) {
                if (e.target.classList.contains('combination-input')) {
                    e.target.value = e.target.value.replace(/[^01]/g, '');
                    const dataBits = parseInt(dataBitsInput.value) || 4;
                    if (e.target.value.length > dataBits) {
                        e.target.value = e.target.value.substring(0, dataBits);
                    }
                }
            });

            dataBitsInput.addEventListener('input', function() {
                const dataBits = parseInt(this.value) || 4;
                const inputs = container.querySelectorAll('.combination-input');
                inputs.forEach(input => {
                    if (input.value.length > dataBits) {
                        input.value = input.value.substring(0, dataBits);
                    }
                });
            });

            function updateRemoveButtons() {
                const rows = container.querySelectorAll('.combination-row');
                rows.forEach(row => {
                    const btn = row.querySelector('.remove-combination');
                    btn.disabled = rows.length <= 1;
                });
            }

            function reindexCombinations() {
                const rows = container.querySelectorAll('.combination-row');
                rows.forEach((row, index) => {
                    const input = row.querySelector('.combination-input');
                    if (input) input.name = `InformationCombinations[${index}]`;
                });
                combinationIndex = rows.length;
            }

            document.getElementById('resetForm').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите сбросить форму?')) {
                    location.reload();
                }
            });
        });
    </script>
}
